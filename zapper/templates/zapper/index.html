{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Video Capture Example</title>
    {#<link href="js_example_style.css" rel="stylesheet" type="text/css" />#}
    <style>
        #video_box {
            float: left;
        }

        #videoInput{
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
        }

        #video_overlays {
            position: absolute;
            float: left;
            width: 640px;
            min-height: 480px;
            /*background-color:rgba(0, 0, 255, 0.3);*/
            background-image: url("{% static 'square_frame.png' %}");
            z-index: 300000;
            
        }
    </style>
</head>
<body>
{% csrf_token %}
<div>
    <div class="control">
        <button id="zap">Zap</button>
    </div>
    <div>
        <p id="zap_return"></p>
    </div>
    <!--textarea class="code" rows="29" cols="100" id="codeEditor" spellcheck="false">
    </textarea-->
</div>
<p class="err" id="errorMessage"></p>
<div>
    <table cellpadding="0" cellspacing="0" width="0" border="0">
        <tr>
            <td>
                <div id="video_box">
                    <div id="video_overlays"></div>
                    <div>
                        <video id="videoInput" width=640 height=480 ></video>
                        
                    </div>
                </div>
            </td>
        </tr>
        </table>
        <table>
        <tr>
            <td>
                <h1>ROI</h1>
                <canvas id="captured" width=300 height=300></canvas>
            </td>
        </tr>
        <tr>
            <td>
                <h1>Data</h1>
                <canvas id="canvasOutput1" width=300 height=300></canvas>
            </td>

            <td>
                <h1>Data2</h1>
                <canvas id="canvasOutput2" width=300 height=300></canvas>
            </td>
            
            <td>
                <h1>Data3</h1>
                <canvas id="canvasOutput3" width=300 height=300></canvas>
            </td>
        </tr>

    </table>
</div>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://webrtc.github.io/adapter/adapter-5.0.4.js" type="text/javascript"></script>
<script src="{% static 'opencv.js' %}" type="text/javascript"></script>
<script src="{% static 'utils.js' %}" type="text/javascript"></script>
<script src="{% static 'mousetrap.min.js' %}" type="text/javascript"></script>


<script type="text/javascript">
    let utils = new Utils('errorMessage');

    //utils.loadCode('codeSnippet', 'codeEditor');

    let streaming = false;
    let videoInput = document.getElementById('videoInput');

    let zap = document.getElementById('zap');
    let captured = document.getElementById('captured');
    let canvasOutput2 = document.getElementById('canvasOutput2');
    let canvasContext = captured.getContext('2d');

    //////
    let video = document.getElementById('videoInput');
    console.log(video.height);
    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
    let cap = new cv.VideoCapture(videoInput);

    const FPS = 30;

    function processVideo() {
        try {
            if (!streaming) {
                // clean and stop.
                src.delete();
                dst.delete();
                let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
                return;
            }
            let begin = Date.now();
            // start processing.
            cap.read(src);
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
            cv.imshow('captured', dst);
            // schedule the next one.
            let delay = 1000 / FPS - (Date.now() - begin);
            setTimeout(processVideo, delay);
        } catch (err) {
            utils.printError(err);
        }
    };

    /////

    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
//  
    function save_image(save_at){
        cap.read(src);
        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
        let rect = new cv.Rect(160,100,300,300);
        croped=dst.roi(rect);
        let thresholded = new cv.Mat();
        let blurred = new cv.Mat();
        let ksize = new cv.Size(5, 5);
        
        cv.GaussianBlur(croped, blurred, ksize, -1, -1, cv.BORDER_DEFAULT);
        cv.threshold(blurred, thresholded, 0, 255, cv.THRESH_BINARY+cv.THRESH_OTSU);
        cv.imshow('captured', croped);
        cv.imshow(save_at, thresholded);
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function save_image_async() {
            save_image('canvasOutput1');
            await sleep(200);
            save_image('canvasOutput2');
            await sleep(200);
            save_image('canvasOutput3');
        }

    function capture(test_code) {
        document.getElementById("zap_return").innerHTML="Waiting...";

        save_image_async();
        
        
        var dataURL1 = canvasOutput1.toDataURL();
        var dataURL2 = canvasOutput2.toDataURL();
        var dataURL3 = canvasOutput3.toDataURL();

        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
        
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        

        $.ajax({
            type: "POST",
            url: window.location.hostname+"/zap/scan/",
            data: {
                //imgBase64: dataURL
                payload1: dataURL1, 
                payload2: dataURL2,
                payload3: dataURL3,
            
                timestamp: $.now(),
                test_code: test_code
                //CSRF : document.getElementsByName('csrfmiddlewaretoken')[0].value,

            }
        }).done(function (o) {
            document.getElementById("zap_return").innerHTML=o;

        });
    }


    zap.addEventListener('click', () => {
        capture(4);
    });


    function onVideoStarted() {
        streaming = true;
        //startAndStop.innerText = 'Stop';
        videoInput.width = videoInput.videoWidth;
        videoInput.height = videoInput.videoHeight;
        //utils.executeCode('codeEditor');
        //setTimeout(processVideo, 0);
        
    }

    utils.startCamera('vga', onVideoStarted, 'videoInput');

    Mousetrap.bind('1', function(e) {
        //console.log("bugagag"); // logs 'ctrl+shift+up'
        capture(1);
    });
    Mousetrap.bind('2', function(e) {
        //console.log("bugagag"); // logs 'ctrl+shift+up'
        capture(2);
    });
    Mousetrap.bind('3', function(e) {
        //console.log("bugagag"); // logs 'ctrl+shift+up'
        capture(3);
    });
    Mousetrap.bind('4', function(e) {
        //console.log("bugagag"); // logs 'ctrl+shift+up'
        capture(4);
    });



//only croped
        // croped=dst.roi(rect);
        // cv.imshow('canvasOutput', croped);
        // cv.imshow('canvasOutput2', croped); 
        // var dataURL = canvasOutput.toDataURL();

        //croped then resized
        // croped=dst.roi(rect);
        // let dsize = new cv.Size(150, 150);
        // let resized = new cv.Mat();
        // cv.resize(croped, resized, dsize, 0,0, cv.INTER_AREA);
        // cv.imshow('canvasOutput', croped);
        // cv.imshow('canvasOutput2', resized);
        // var dataURL = canvasOutput2.toDataURL();
        
        
        //croped and edged
        // croped=dst.roi(rect);
        // let edged = new cv.Mat(300,300,cv.CV_8UC1)
        // cv.Canny(croped, edged, 100,200)
        // let thresholded = new cv.Mat();
        // cv.threshold(croped, thresholded, 177, 200, cv.THRESH_BINARY);
        // cv.imshow('canvasOutput', thresholded);
        // cv.imshow('canvasOutput2', edged);
        // var dataURL = canvasOutput2.toDataURL();
        // var img = canvasOutput.toDataURL();


        //croped then thresholded
        // croped=dst.roi(rect);
        // let thresholded = new cv.Mat();
        // cv.threshold(croped, thresholded, 177, 200, cv.THRESH_BINARY+cv.THRESH_OTSU);
        // cv.imshow('canvasOutput', croped);
        // cv.imshow('canvasOutput2', thresholded);
        // var dataURL = canvasOutput2.toDataURL();

        //croped then blurred then thresholded


        // let dsize = new cv.Size(150, 150);
        // let resized = new cv.Mat();
        // let edged = new cv.Mat(300,300,cv.CV_8UC1)
        // let thresholded = new cv.Mat();
        // cv.Canny(croped, edged, 100,200)
        // //cv.resize(croped, resized, dsize, 0,0, cv.INTER_AREA);
        // cv.imshow('canvasOutput', croped);
        // cv.threshold(croped, thresholded, 177, 200, cv.THRESH_BINARY);
        // cv.imshow('canvasOutput2', thresholded);
</script>
</body>
</html>
